<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QRã‚³ãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ«</title>
  <style>
    :root {
      --bg: #f7f8fa;
      --text: #111;
      --card: #fff;
      --border: #d9dee3;
      --muted: #616b74;
    }
    :root.dark {
      --bg: #0f172a;
      --text: #f1f5f9;
      --card: #1e293b;
      --border: #334155;
      --muted: #94a3b8;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
    }
    h1 {
      font-size: 18px;
      margin: 0;
    }
    .theme {
      cursor: pointer;
    }
    nav.tabs {
      display: flex;
      gap: 8px;
      padding: 0 16px 16px;
    }
    nav.tabs button {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
    }
    .tab {
      display: none;
      padding: 0 16px 32px;
    }
    .tab.active {
      display: block;
    }
  </style>
  <script>
    const theme = localStorage.getItem('theme');
    if (theme === 'dark') document.documentElement.classList.add('dark');
    function toggleTheme() {
      const root = document.documentElement;
      const isDark = root.classList.contains('dark');
      if (isDark) {
        root.classList.remove('dark');
        localStorage.removeItem('theme');
      } else {
        root.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
    }
    function showTab(name) {
      ['generate', 'image', 'camera'].forEach(id => {
        const el = document.getElementById('tab-' + id);
        if (el) el.classList.toggle('active', id === name);
      });
    }
    window.addEventListener('DOMContentLoaded', () => showTab('generate'));
  </script>
</head>
<body>
  <header>
    <h1>QRã‚³ãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ«</h1>
    <button class="theme" onclick="toggleTheme()">ğŸŒ—</button>
  </header>
  <nav class="tabs">
    <button onclick="showTab('generate')">ç”Ÿæˆ</button>
    <button onclick="showTab('image')">ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š</button>
    <button onclick="showTab('camera')">ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚Š</button>
  </nav>
  <div id="tab-generate" class="tab active">
    <h2>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</h2>
    <div class="row">
      <input type="text" id="qr-text" value="https://ad-hub.f5.si/" size="40" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚„URLã‚’å…¥åŠ›" />
      <button onclick="generateQR()">ç”Ÿæˆ</button>
    </div>

    <div class="details">
      <h3>è©³ç´°è¨­å®š</h3>

      <div class="row">
        ã‚µã‚¤ã‚º:
        <select id="qr-size">
          <option value="256">256px</option>
          <option value="384">384px</option>
          <option value="512" selected>512px</option>
        </select>
        ä½™ç™½:
        <input type="number" id="qr-margin" value="2" min="0" max="16" />
        <label><input type="checkbox" id="qr-transparent" /> èƒŒæ™¯é€é</label>
      </div>

      <div class="row">
        è‰²:
        <input type="color" id="qr-dark" value="#000000" />
        <input type="color" id="qr-light" value="#ffffff" />
      </div>

      <div class="row">
        ä¸­å¤®ã‚¢ã‚¤ã‚³ãƒ³:
        <input type="file" id="qr-icon" accept="image/*" />
        ã‚µã‚¤ã‚º:
        <input type="range" id="icon-size" min="10" max="50" value="20" />
        <span id="icon-size-label">20%</span>
        <br />
        <img id="icon-preview" class="icon-preview" style="max-width:64px; max-height:64px;" />
      </div>

      <div class="row">
        <label><input type="checkbox" id="live-preview" checked /> ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
      </div>

      <div class="row">
        <button onclick="downloadPNG()">PNGã§ä¿å­˜</button>
        <button onclick="downloadSVG()">SVGã§ä¿å­˜</button>
      </div>
    </div>

    <canvas id="qr-canvas" style="margin-top:1rem; border:1px solid #ccc;"></canvas>
  </div>
  <div id="tab-image" class="tab">
    <h2>ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š</h2>
    <input type="file" id="file-input" accept="image/*" />
    <button onclick="decodeImage()">è§£æ</button>
    <p id="img-result" style="margin-top:1rem; font-family:monospace;"></p>
    <img id="img-preview" style="max-width:100%; margin-top:1rem;" />
  </div>

  <div id="tab-camera" class="tab">
    <h2>ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚Š</h2>
    <button onclick="startCamera()">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
    <button onclick="stopCamera()">åœæ­¢</button>
    <video id="video" playsinline style="width:100%; max-width:400px; margin-top:1rem;"></video>
    <p id="cam-result" style="margin-top:1rem; font-family:monospace;"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
    const canvas = document.getElementById('qr-canvas');
    const ctx = canvas.getContext('2d');
    const iconInput = document.getElementById('qr-icon');
    const iconPreview = document.getElementById('icon-preview');
    let iconImage = null;

    iconInput.addEventListener('change', () => {
      const file = iconInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        iconImage = new Image();
        iconImage.onload = () => generateQR();
        iconImage.src = reader.result;
        iconPreview.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('icon-size').addEventListener('input', e => {
      document.getElementById('icon-size-label').textContent = e.target.value + '%';
      if (document.getElementById('live-preview').checked) generateQR();
    });

    document.querySelectorAll('#qr-text, #qr-size, #qr-margin, #qr-dark, #qr-light, #qr-transparent')
      .forEach(el => el.addEventListener('input', () => {
        if (document.getElementById('live-preview').checked) generateQR();
      }));

    function generateQR() {
      const text = document.getElementById('qr-text').value || ' ';
      const size = parseInt(document.getElementById('qr-size').value);
      const margin = parseInt(document.getElementById('qr-margin').value);
      const dark = document.getElementById('qr-dark').value;
      const light = document.getElementById('qr-light').value;
      const transparent = document.getElementById('qr-transparent').checked;

      const qr = qrcode(0, 'H');
      qr.addData(text);
      qr.make();

      const cellSize = Math.floor(size / qr.getModuleCount());
      const qrSize = cellSize * qr.getModuleCount();
      canvas.width = canvas.height = qrSize + margin * 2 * cellSize;

      ctx.fillStyle = transparent ? 'rgba(0,0,0,0)' : light;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      for (let r = 0; r < qr.getModuleCount(); r++) {
        for (let c = 0; c < qr.getModuleCount(); c++) {
          if (qr.isDark(r, c)) {
            ctx.fillStyle = dark;
            ctx.fillRect(
              margin * cellSize + c * cellSize,
              margin * cellSize + r * cellSize,
              cellSize, cellSize
            );
          }
        }
      }

      if (iconImage) {
        const iconScale = parseInt(document.getElementById('icon-size').value) / 100;
        const iconSize = qrSize * iconScale;
        const x = (canvas.width - iconSize) / 2;
        const y = (canvas.height - iconSize) / 2;
        ctx.drawImage(iconImage, x, y, iconSize, iconSize);
      }
    }

    function downloadPNG() {
      const link = document.createElement('a');
      link.download = 'qr.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function downloadSVG() {
      alert('SVGä¿å­˜ã¯ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯æœªå¯¾å¿œã§ã™ï¼ˆåˆ¥ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ï¼‰');
    }

    function decodeImage() {
      const file = document.getElementById('file-input').files[0];
      const img = document.getElementById('img-preview');
      const result = document.getElementById('img-result');
      result.textContent = '';
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = img.naturalWidth;
          tempCanvas.height = img.naturalHeight;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(img, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const code = jsQR(imageData.data, tempCanvas.width, tempCanvas.height);
          result.textContent = code ? code.data : 'QRãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ';
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    let stream = null;
    async function startCamera() {
      const video = document.getElementById('video');
      const result = document.getElementById('cam-result');
      result.textContent = '';
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        await video.play();
        const interval = setInterval(() => {
          if (!video.videoWidth) return;
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = video.videoWidth;
          tempCanvas.height = video.videoHeight;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(video, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const code = jsQR(imageData.data, tempCanvas.width, tempCanvas.height);
          if (code) {
            result.textContent = code.data;
            stopCamera();
            clearInterval(interval);
          }
        }, 300);
      } catch (e) {
        alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + e.message);
      }
    }

    function stopCamera() {
      const video = document.getElementById('video');
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
    }

    generateQR();
  </script>
</body>
</html>
