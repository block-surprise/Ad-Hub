<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SURGE MAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }
    aside {
      width: 300px;
      background: #f8fafc;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      padding: 10px;
    }
    #map {
      flex: 1;
    }
    header {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #f0f4f8;
      flex-wrap: wrap;
    }
    input, button {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 6px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    li:hover {
      background: #e0f2fe;
    }
  </style>
</head>
<body>
  <aside>
    <header>
      <input type="text" id="searchInput" placeholder="例：ダイソー 渋谷" />
      <button id="searchBtn">検索</button>
    </header>
    <ul id="results"></ul>
  </aside>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([35.6812, 139.7671], 14);
    let markers = L.layerGroup().addTo(map);
    let routeLayer = null;
    let currentLocation = null;
    let following = true;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsList = document.getElementById('results');

    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        searchBtn.click();
      }
    });

    searchBtn.addEventListener('click', () => {
      const query = searchInput.value.trim();
      if (query) {
        searchKeyword(query);
      }
    });

    map.on('movestart', () => {
      following = false;
    });

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        currentLocation = [lat, lon];
        if (following) {
          map.setView(currentLocation, 16);
        }
        L.circleMarker(currentLocation, {
          radius: 8,
          color: '#2563eb',
          fillColor: '#3b82f6',
          fillOpacity: 0.8
        }).addTo(markers).bindPopup("現在地");
      }, err => {
        console.warn("現在地を取得できませんでした");
      }, { enableHighAccuracy: true });
    }

    function searchKeyword(query) {
      markers.clearLayers();
      if (routeLayer) {
        map.removeLayer(routeLayer);
        routeLayer = null;
      }
      resultsList.innerHTML = '';
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=20`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            alert("見つかりませんでした");
            return;
          }

          const results = data.map(place => {
            const lat = parseFloat(place.lat);
            const lon = parseFloat(place.lon);
            const name = place.display_name;
            const distance = currentLocation
              ? getDistance(currentLocation[0], currentLocation[1], lat, lon)
              : null;
            return { name, lat, lon, distance };
          });

          results.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));

          results.forEach(item => {
            const marker = L.marker([item.lat, item.lon]).addTo(markers);
            marker.bindPopup(`<strong>${item.name}</strong>`);
            const li = document.createElement('li');
            li.textContent = item.name + (item.distance ? `（約${item.distance.toFixed(1)}km）` : '');
            li.addEventListener('click', () => {
              map.setView([item.lat, item.lon], 17);
              marker.openPopup();
              if (currentLocation) {
                drawRoute(currentLocation, [item.lat, item.lon]);
              } else {
                alert("現在地が取得できていません");
              }
            });
            resultsList.appendChild(li);
          });

          map.setView([results[0].lat, results[0].lon], 16);
        });
    }

    function drawRoute(from, to) {
      const url = `https://router.project-osrm.org/route/v1/foot/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (routeLayer) {
            map.removeLayer(routeLayer);
          }
          const route = data.routes[0];
          routeLayer = L.geoJSON(route.geometry, {
            style: { color: "#10b981", weight: 5 }
          }).addTo(map);
          const distance = route.distance / 1000;
          const duration = route.duration / 60;
          alert(`距離：約${distance.toFixed(2)}km\n所要時間：約${duration.toFixed(0)}分`);
        })
        .catch(err => {
          alert("ルートを取得できませんでした");
          console.error(err);
        });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
  </script>
</body>
</html>
