<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»èª­ã¿å–ã‚Š</title>
<style>
  :root {
    --bg: #f7f8fa;
    --text: #111;
    --card: #fff;
    --border: #d9dee3;
    --muted: #616b74;
  }
  :root.dark {
    --bg: #0f172a;
    --text: #f1f5f9;
    --card: #1e293b;
    --border: #334155;
    --muted: #94a3b8;
  }
  body {
    margin: 0; font-family: system-ui, -apple-system, "Hiragino Sans", sans-serif;
    background: var(--bg); color: var(--text);
  }
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px;
  }
  h1 { font-size: 18px; margin: 0; }
  .theme { cursor: pointer; }
  main { padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
  .card {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px;
  }
  .card h2 { font-size: 16px; margin: 0 0 12px; }
  .row { display: grid; gap: 8px; }
  input[type="text"], textarea, select, button {
    font: inherit; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
    background: #fff; color: #111;
  }
  :root.dark input[type="text"], :root.dark textarea, :root.dark select, :root.dark button {
    background: var(--bg); color: var(--text); border-color: var(--border);
  }
  button { cursor: pointer; }
  .muted { color: var(--muted); font-size: 12px; }
  .preview {
    display: grid; place-items: center; border: 1px dashed var(--border);
    border-radius: 8px; min-height: 220px; background: rgba(0,0,0,0.02);
  }
  .actions { display: flex; gap: 8px; flex-wrap: wrap; }
  canvas, img, video { max-width: 100%; border-radius: 8px; }
  .result { font-family: ui-monospace, Menlo, Consolas, monospace; white-space: pre-wrap; word-break: break-word; }
</style>
<script>
  // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒåˆæœŸåŒ–
  const theme = localStorage.getItem('theme');
  if (theme === 'dark') document.documentElement.classList.add('dark');
</script>
</head>
<body>
<header>
  <h1>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»èª­ã¿å–ã‚Š</h1>
  <button class="theme" onclick="toggleTheme()">ğŸŒ—</button>
</header>

<main>
  <!-- ç”Ÿæˆ -->
  <section class="card">
    <h2>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</h2>
    <div class="row">
      <input id="qr-text" type="text" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚„URLã‚’å…¥åŠ›" />
      <div class="actions">
        <select id="qr-size">
          <option value="256">256px</option>
          <option value="384">384px</option>
          <option value="512">512px</option>
        </select>
        <input id="qr-margin" type="number" min="0" max="16" value="2" title="ä½™ç™½" />
        <input id="qr-dark" type="color" value="#111111" title="å‰æ™¯è‰²" />
        <input id="qr-light" type="color" value="#ffffff" title="èƒŒæ™¯è‰²" />
        <button onclick="makeQR()">ç”Ÿæˆ</button>
        <button onclick="downloadQR()">PNGã§ä¿å­˜</button>
      </div>
      <div class="preview"><canvas id="qr-canvas" width="256" height="256"></canvas></div>
      <div class="muted">ç”Ÿæˆã•ã‚ŒãŸQRã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã•ã‚Œã¾ã™ã€‚</div>
    </div>
  </section>

  <!-- ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š -->
  <section class="card">
    <h2>ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š</h2>
    <div class="row">
      <input id="file-input" type="file" accept="image/*" />
      <div class="actions">
        <button onclick="decodeImage()">è§£æ</button>
        <button onclick="clearImage()">ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="preview"><img id="img-preview" alt="" /></div>
      <div class="muted">ç”»åƒã‚’é¸ã‚“ã§ã€Œè§£æã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
      <div class="result" id="img-result"></div>
    </div>
  </section>

  <!-- ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚Š -->
  <section class="card">
    <h2>ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚Š</h2>
    <div class="row">
      <div class="actions">
        <button onclick="startCamera()">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
        <button onclick="stopCamera()">åœæ­¢</button>
      </div>
      <video id="video" playsinline></video>
      <div class="result" id="cam-result"></div>
      <div class="muted">å‘¨å›²ãŒæš—ã„å ´åˆã¯æ˜ã‚‹ã„å ´æ‰€ã§ãŠè©¦ã—ãã ã•ã„ã€‚</div>
    </div>
  </section>
</main>

<!-- jsQRï¼ˆQRè§£æãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
  // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒåˆ‡æ›¿
  function toggleTheme(){
    const root = document.documentElement;
    const isDark = root.classList.contains('dark');
    if (isDark) { root.classList.remove('dark'); localStorage.removeItem('theme'); }
    else { root.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
  }

  // QRç”Ÿæˆï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ç›´æ¥å®Ÿè£…ï¼‰
  function makeQR(){
    const text = document.getElementById('qr-text').value;
    const size = parseInt(document.getElementById('qr-size').value, 10);
    const margin = parseInt(document.getElementById('qr-margin').value, 10);
    const dark = document.getElementById('qr-dark').value;
    const light = document.getElementById('qr-light').value;

    const canvas = document.getElementById('qr-canvas');
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext('2d');

    // ç°¡æ˜“ç”Ÿæˆã¯é›£ã—ã„ã®ã§ã€è»½é‡ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ä½¿ç”¨
    // QRCodeç”Ÿæˆç”¨ã®æœ€å°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ãƒ»ç”Ÿæˆ
    // ã“ã“ã§ã¯å‹•ä½œå®‰å®šã®ãŸã‚ CDN ã‚’ä½¿ç”¨
    loadScriptOnce('https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js', () => {
      // èƒŒæ™¯
      ctx.fillStyle = light; ctx.fillRect(0, 0, size, size);
      // æç”»ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä»»ã›ã‚‹
      QRCode.toCanvas(canvas, text || ' ', {
        width: size,
        margin,
        color: { dark, light }
      }, (err) => {
        if (err) alert('QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      });
    });
  }

  function downloadQR(){
    const canvas = document.getElementById('qr-canvas');
    const link = document.createElement('a');
    link.download = 'qr.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  }

  // ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Š
  function decodeImage(){
    const file = document.getElementById('file-input').files[0];
    const img = document.getElementById('img-preview');
    const result = document.getElementById('img-result');
    result.textContent = '';

    if (!file) { alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const reader = new FileReader();
    reader.onload = () => {
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        result.textContent = code ? code.data : 'QRãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ';
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  }
  function clearImage(){
    document.getElementById('file-input').value = '';
    document.getElementById('img-preview').src = '';
    document.getElementById('img-result').textContent = '';
  }

  // ã‚«ãƒ¡ãƒ©èª­ã¿å–ã‚Š
  let stream = null, camTimer = null;
  async function startCamera(){
    const video = document.getElementById('video');
    document.getElementById('cam-result').textContent = '';
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      await video.play();
      // ãƒ«ãƒ¼ãƒ—è§£æ
      camTimer = setInterval(() => scanFrame(video), 250);
    } catch (e) {
      alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + e.message);
    }
  }
  function stopCamera(){
    clearInterval(camTimer);
    camTimer = null;
    const video = document.getElementById('video');
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
  }
  function scanFrame(video){
    if (!video.videoWidth) return;
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) {
      document.getElementById('cam-result').textContent = code.data;
      // è¦‹ã¤ã‘ãŸã‚‰åœæ­¢ï¼ˆå¿…è¦ãªã‚‰ç¶™ç¶šã«å¤‰æ›´å¯ï¼‰
      stopCamera();
    }
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¸€åº¦ã ã‘ãƒ­ãƒ¼ãƒ‰
  const loaded = new Set();
  function loadScriptOnce(src, cb){
    if (loaded.has(src)) return cb();
    const s = document.createElement('script');
    s.src = src; s.onload = () => { loaded.add(src); cb(); };
    s.onerror = () => alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + src);
    document.head.appendChild(s);
  }

  // åˆæœŸæç”»
  makeQR();
</script>
</body>
</html>
