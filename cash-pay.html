<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>My Pay - ã‚¹ã‚­ãƒ£ãƒ³æ”¯æ‰•</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #9b59b6; color: white; margin: 0; padding-top: 50px; }
        .card { background: white; color: #333; width: 90%; margin: 0 auto; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); box-sizing: border-box; }
        .balance { font-size: 4rem; font-weight: bold; color: #9b59b6; margin: 10px 0; }
        .btn-scan { background: #9b59b6; color: white; width: 100%; padding: 20px; font-size: 1.3rem; font-weight: bold; border-radius: 15px; border: none; margin-top: 20px; cursor: pointer; }
        #video-container { display: none; margin-top: 20px; width: 100%; height: 350px; background: black; border-radius: 15px; overflow: hidden; position: relative; }
        #preview { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div class="card">
    <div style="color:#888;">ãƒã‚¤æ®‹é«˜</div>
    <div class="balance">Â¥<span id="balance">0</span></div>
    <button class="btn-scan" id="scan-btn" onclick="startScan()">ğŸ“· ãŠåº—ã®QRã‚’èª­ã¿å–ã‚‹</button>
    <div id="video-container">
        <video id="preview" playsinline></video>
        <button onclick="stopScan()" style="position:absolute; bottom:10px; left:10%; width:80%; padding:10px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<script type="module">
    let myBalance = parseInt(localStorage.getItem('my_pay_balance')) || 0;
    const balanceEl = document.getElementById('balance');

    function updateView() {
        balanceEl.innerText = myBalance.toLocaleString();
        localStorage.setItem('my_pay_balance', myBalance);
    }

    const video = document.getElementById("preview");
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    let scanning = false;
    let lastPayId = "";

    window.startScan = () => {
        scanning = true;
        document.getElementById('video-container').style.display = 'block';
        document.getElementById('scan-btn').style.display = 'none';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            video.srcObject = s; video.play(); requestAnimationFrame(tick);
        });
    };

    window.stopScan = () => {
        scanning = false;
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('video-container').style.display = 'none';
        document.getElementById('scan-btn').style.display = 'block';
    };

    function tick() {
        if (!scanning) return;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight; canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            
            if (code && code.data) {
                // 1. ãƒãƒ£ãƒ¼ã‚¸QRã‚’èª­ã‚“ã å ´åˆ
                if (code.data.startsWith("CHARGE_")) {
                    const amt = parseInt(code.data.split("_")[1]);
                    myBalance += amt;
                    alert("Â¥" + amt + " ãƒãƒ£ãƒ¼ã‚¸ã—ã¾ã—ãŸï¼");
                    stopScan(); updateView();
                } 
                // 2. æ±ºæ¸ˆQRã‚’èª­ã‚“ã å ´åˆ
                else if (code.data.startsWith("PAY_")) {
                    const parts = code.data.split("_");
                    const amt = parseInt(parts[1]);
                    const payId = parts[2];

                    if (payId !== lastPayId) {
                        lastPayId = payId;
                        if (myBalance >= amt) {
                            myBalance -= amt;
                            alert("Â¥" + amt + " ãŠæ”¯æ‰•ã„å®Œäº†ï¼");
                            stopScan(); updateView();
                        } else {
                            alert("æ®‹é«˜ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                            stopScan();
                        }
                    }
                }
            }
        }
        requestAnimationFrame(tick);
    }
    updateView();
</script>
</body>
</html>
