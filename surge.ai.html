<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SURGE AI â€” Chat</title>
<style>
/* ================================================= */
/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Œå…¨ã«æ¡ç”¨ */
/* ================================================= */
Â  :root {
Â  Â  --bg:#f7f7f7; --panel:#fff; --ink:#222; --mute:#777; --accent:#2458b8;
Â  Â  --ring:rgba(36,88,184,.18); --shadow:0 8px 30px rgba(0,0,0,.08);
Â  }
Â  
 /* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®èª¿æ•´ */
  body { margin: 0; height:100%; background: var(--bg); color: var(--ink); font-family: system-ui,-apple-system,"Helvetica Neue",Arial, sans-serif; }
  .wrapper { max-width: 1200px; margin: 20px auto; display: flex; gap: 20px; padding: 0 10px; }
  .main-content {
      flex-grow: 1;
      padding: 0; 
      border: none;
      background: none;
      box-shadow: none;
      display: flex;
      flex-direction: column;
  }
  
  /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ (ãƒ„ãƒ¼ãƒ«ç’°å¢ƒã«å¿…é ˆ) */
  .sidebar { 
      width: 300px;
      padding: 20px;
      background-color: #e9ecef;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      flex-shrink: 0; 
  }
  .sidebar h3 { color: #007bff; border-bottom: 2px solid #b8daff; padding-bottom: 5px; margin-top: 0; }
  .sidebar ul { list-style: none; padding: 0; }
  .sidebar li { margin-bottom: 10px; }
  .sidebar a { text-decoration: none; color: #333; padding: 5px; display: block; border-radius: 4px; transition: background-color 0.2s; }
  .sidebar a:hover { background-color: #d6eaff; color: #0056b3; }
  
  /* æä¾›ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³ã®ç¶­æŒ */
Â  .wrap{max-width:100%;margin:0;padding:0; flex-grow: 1; display: flex; flex-direction: column;}
Â  .card{background:var(--panel);border:1px solid #eee;border-radius:16px;box-shadow:var(--shadow);overflow:hidden; flex-grow: 1; display: flex; flex-direction: column;}
Â  .head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #f0f0f0;}
Â  .title{font-size:15px;color:var(--mute);}
Â  .body{min-height:300px;max-height:55vh;overflow:auto;padding:14px 16px; flex-grow: 1;}
Â  .msg{margin:8px 0;display:inline-block;max-width:80%;padding:10px 12px;border-radius:12px;line-height:1.55;white-space:pre-wrap;box-shadow:0 2px 6px rgba(0,0,0,.06);}
Â  .msg.user{background:#eef3ff; margin-left:auto;}
Â  .msg.ai{background:#f9f9f9;margin-right:auto;display:block;}
  .msg .role {
    font-size: 0.8em;
    font-weight: bold;
    margin-bottom: 3px;
    opacity: 0.7;
    color: var(--mute);
  }
Â  .bar{display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px;border-top:1px solid #f0f0f0;background:#fcfcfc;}
Â  .input{width:100%;padding:12px;border:1px solid #e6e6e6;border-radius:12px;outline:none;font-size:15px;background:#fff;}
Â  .input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--ring);}
Â  .btn{padding:12px 16px;border-radius:12px;border:1px solid #dfe8ff;background:#eaf2ff;color:var(--accent);font-weight:600;cursor:pointer; transition: background-color 0.2s;}
Â  .btn:hover{background:#e3eeff;}
  .btn:disabled{cursor: not-allowed; opacity: 0.6; background: #ccc !important; color: #666 !important;}
Â  .skeleton{height:12px;width:66%;background:linear-gradient(90deg,#eee,#f7f7f7,#eee);background-size:200% 100%;animation:pulse 1.2s infinite;border-radius:8px;margin:6px 0;}
Â  @keyframes pulse{0%{background-position:0 0}50%{background-position:100% 0}100%{background-position:0 0}}
Â  .note{color:#999;font-size:12px;margin-top:10px;text-align:right;padding:0 4px;}

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 1024px) {
      .wrapper {
          flex-direction: column;
          margin: 10px;
          gap: 10px;
      }
      .sidebar {
          width: auto;
      }
      .body {
          max-height: 40vh; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®é«˜ã•ã‚’èª¿æ•´ */
      }
  }
</style>
</head>
<body>
    <div class="wrapper">

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <div class="wrap">
                <div class="card">
                    <div class="head">
                        <div class="title">ğŸ¤– Surge AI â€” é™ã‹ãªãƒãƒ£ãƒƒãƒˆ</div>
                        <button class="btn" id="clearBtn">å±¥æ­´ã‚¯ãƒªã‚¢</button>
                    </div>
                    
                    <!-- ãƒãƒ£ãƒƒãƒˆãƒ­ã‚° -->
                    <div class="body" id="log">
                        <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JSã§è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <div class="bar">
                        <input class="input" id="inp" placeholder="ã„ã¾è€ƒãˆã¦ã„ã‚‹ã“ã¨ã‚’ã€ãã®ã¾ã¾â€¦" autocomplete="off">
                        <button class="btn" id="sendBtn">é€ä¿¡</button>
                    </div>
                </div>
                <div class="note" id="status-message">
                    Workers çµŒç”±ã§å¿œç­”ã—ã¾ã™ã€‚APIã‚­ãƒ¼ã¯ä¸è¦ã§ã™ã€‚
                </div>
            </div>
        </div>

        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ (å…±é€š) -->
        <div class="sidebar">
            <h3>ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«é›†</h3>
            <ul id="dynamic-tool-list">
                <li>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</li>
            </ul>

            <h3 style="margin-top: 30px;">ãƒãƒ£ãƒƒãƒˆã®ãƒ’ãƒ³ãƒˆ</h3>
            <ul style="font-size: 0.9em; list-style-type: square; margin-left: 10px;">
                <li>âœ… è¶£å‘³ã‚„ä»•äº‹ã«é–¢ã™ã‚‹è³ªå•</li>
                <li>âœ… è¦ç´„ã‚„ã‚¢ã‚¤ãƒ‡ã‚¢å‡ºã—</li>
                <li>âœ… Webæ¤œç´¢ã¯è¡Œã„ã¾ã›ã‚“ï¼ˆçŸ¥è­˜ã¯å­¦ç¿’æ™‚ç‚¹ã¾ã§ï¼‰</li>
                <li>âš ï¸ é•·ã„è³ªå•ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
            </ul>
        </div>
    </div>


<script>
// ğŸš¨ ãŠå®¢æ§˜è‡ªèº«ã®Worker URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
//     è¨­å®šå¾Œã€GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§ã‚­ãƒ¼ãƒ¬ã‚¹ã§å‹•ä½œã—ã¾ã™ã€‚
const WORKER_URL = "https://surgeai.proluce.workers.dev/"; 
const JSON_URL = 'tools.json';
const TOP_TOOLS_COUNT = 4;

const log = document.getElementById("log");
const inp = document.getElementById("inp");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const statusMsg = document.getElementById("status-message");

let chatHistory = []; 

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã«è¿½åŠ ã—ã€è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ 
 */
function addMsg(text, role="ai"){
    const el = document.createElement("div");
    el.className = `msg ${role}`;
    
    // å½¹å‰²å
    const roleEl = document.createElement("div");
    roleEl.className = "role";
    roleEl.textContent = role === 'user' ? 'ã‚ãªãŸ' : 'Surge AI';
    el.appendChild(roleEl);

    el.appendChild(document.createTextNode(text));

    log.appendChild(el);
    log.scrollTop = log.scrollHeight;
}

/**
 * Workerã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ (ã‚­ãƒ¼ãƒ¬ã‚¹ã®è¦ä»¶ã‚’æº€ãŸã™ãƒ­ã‚¸ãƒƒã‚¯)
 */
async function requestWorker(prompt){
    // ä¼šè©±å±¥æ­´ã‚’å«ã‚ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
    const historyString = chatHistory.map(msg => `${msg.role === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'AI'}: ${msg.text}`).join('\n');
    
    // Workerå´ã®ã‚·ã‚¹ãƒ†ãƒ æŒ‡ç¤ºã«åˆã‚ã›ã‚‹
    const system = "ã‚ãªãŸã¯é™ã‹ã§è©©çš„ãªAIã€‚çŸ­ãã€ã‚„ã•ã—ã„è¨€è‘‰ã§è¿”ç­”ã™ã‚‹ã€‚";
    const fullPrompt = `${system}\n${historyString}\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${prompt}\nAI:`;
    
    // Workerã®URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒã‚§ãƒƒã‚¯
    if (WORKER_URL.includes("ã€")) {
         throw new Error("Worker URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }

    // WorkerçµŒç”±ã§ã®é€šä¿¡
    const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ inputs: fullPrompt })
    });
    
    if (!res.ok) {
        throw new Error(`Workerã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${res.status})`);
    }

    const data = await res.json();
    
    // Workerã®å¿œç­”ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆWorkerã‚³ãƒ¼ãƒ‰ã®å‡ºåŠ›å½¢å¼ã«åˆã‚ã›ã‚‹ï¼‰
    const raw = Array.isArray(data)
        ? (data[0]?.generated_text || data[0]?.text || "")
        : (data.generated_text || data.text || "");
        
    // å¿œç­”ã‹ã‚‰AIè‡ªèº«ã®åå‰ã‚„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ®‹ã‚Šã‚’å–ã‚Šé™¤ã ("AI:" ã‚’å‰Šé™¤)
    const reply = raw.split("AI:").pop()?.trim() || raw.trim() || "â€¦â€¦";
    return reply;
}

/**
 * é€ä¿¡ãƒœã‚¿ãƒ³/Enterã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
async function send(){
    const text = inp.value.trim();
    if (!text || sendBtn.disabled) return;
    
    // UIãƒ­ãƒƒã‚¯
    sendBtn.disabled = true;
    inp.disabled = true;
    statusMsg.innerHTML = '<div class="skeleton"></div> å¿œç­”ç”Ÿæˆä¸­...';

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã¨å±¥æ­´è¿½åŠ  (ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢å¼ã§å±¥æ­´ã‚’ä¿æŒ)
    addMsg(text, "user");
    chatHistory.push({ role: "user", text: text });
    inp.value = "";
    
    try {
        const reply = await requestWorker(text);
        
        // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã¨å±¥æ­´è¿½åŠ 
        addMsg(reply, "ai");
        chatHistory.push({ role: "ai", text: reply });
        
        statusMsg.textContent = 'âœ… å®Œäº†';
        statusMsg.style.color = '#28a745'; // æˆåŠŸæ™‚ã®è‰²

    } catch (e) {
        addMsg("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šå¿œç­”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", "ai");
        statusMsg.textContent = "ğŸš¨ ã‚¨ãƒ©ãƒ¼: " + e.message;
        statusMsg.style.color = '#d9534f'; // ã‚¨ãƒ©ãƒ¼æ™‚ã®è‰²
        
        if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
            chatHistory.pop(); // å¤±æ•—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å±¥æ­´ã‹ã‚‰å‰Šé™¤
        }
    } finally {
        // UIè§£é™¤
        sendBtn.disabled = false;
        inp.disabled = false;
        inp.focus();
    }
}

/**
 * å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ (åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾©å…ƒã‚’å«ã‚€)
 */
function clearHistory() { 
    chatHistory = [];
    log.innerHTML = ''; // ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
    const initialMessage = "ã“ã‚“ã«ã¡ã¯ã€‚ç§ã¯ Surge AI ã§ã™ã€‚é™ã‹ã«ã€ã‚„ã•ã—ã„è¨€è‘‰ã§å¯¾è©±ã—ã¾ã™ã€‚";
    addMsg(initialMessage, 'ai');
    
    statusMsg.textContent = 'ãƒãƒ£ãƒƒãƒˆãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚';
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
sendBtn.addEventListener("click", send);
clearBtn.addEventListener("click", clearHistory);
// Enterã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã®å‡¦ç†ã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ã—ã¦è¿½åŠ 
inp.addEventListener("keydown", e => { 
    if (e.key === "Enter" && !sendBtn.disabled) {
        e.preventDefault(); 
        send();
    } 
});

// --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å‹•çš„ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ (å…±é€š) ---
async function loadAndRenderTools(renderFunction, listId) {
    try {
        const response = await fetch(JSON_URL);
        const toolsData = await response.json();
        renderFunction(toolsData, listId);
    } catch (error) {
        const container = document.getElementById(listId);
        if (container) {
            container.innerHTML = `<li style="color:red; font-size:0.9em;">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ (${JSON_URL}) ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚</li>`;
        }
    }
}

function generateSidebarNav(toolsData, listId = 'dynamic-tool-list') {
    const listContainer = document.getElementById(listId);
    if (!listContainer) return;

    let listHtml = '';
    const totalCount = toolsData.length;
    const currentPath = window.location.pathname.split('/').pop() || 'index.html'; 

    toolsData.slice(0, TOP_TOOLS_COUNT).forEach(tool => {
        const toolHref = tool.href + '.html'; 
        const isActive = toolHref === currentPath;
        const activeStyle = isActive ? 'style="background-color: #d6eaff; color: #0056b3;"' : '';
        const title = isActive ? `${tool.icon} ${tool.title} (ç¾åœ¨åœ°)` : `${tool.icon} ${tool.title}`;
        
        listHtml += `<li><a href="${tool.href}.html" ${activeStyle}>${title}</a></li>`;
    });

    const otherCount = totalCount - TOP_TOOLS_COUNT;

    if (otherCount > 0) {
        listHtml += `<hr style="margin: 10px 0;">`;
        listHtml += `<li><a href="tools_index.html" style="font-weight: bold; color: #dc3545;">âœ¨ ãã®ä»– (${otherCount}ä»¶) ã‚’è¦‹ã‚‹</a></li>`;
    }

    listContainer.innerHTML = listHtml;
}

document.addEventListener('DOMContentLoaded', () => {
    loadAndRenderTools(generateSidebarNav, 'dynamic-tool-list');
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºã¨å±¥æ­´ã‚¯ãƒªã‚¢
    clearHistory(); 

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    const statusText = WORKER_URL.includes("ã€") 
        ? "ğŸš¨ Worker URLãŒæœªè¨­å®šã§ã™ã€‚URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"
        : "âœ… Workerè¨­å®šå®Œäº†ã€‚ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚";
        
    statusMsg.textContent = statusText;
    statusMsg.style.color = WORKER_URL.includes("ã€") ? '#d9534f' : '#28a745';

    inp.focus();
});
</script>

</body>
</html>
