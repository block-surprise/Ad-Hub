<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>多機能Webレジ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: white; min-height: 100vh; padding: 20px; box-sizing: border-box; border-left: 1px solid #ddd; border-right: 1px solid #ddd; }
        #interactive.viewport { width: 100%; height: 200px; border: 2px solid #007bff; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        #interactive.viewport video { width: 100%; height: 100%; object-fit: cover; }
        .price-display { font-size: 3.5rem; font-weight: bold; color: #d9534f; text-align: center; margin: 10px 0; background: #fffbe6; border-radius: 10px; padding: 10px; }
        .input-group { display: flex; gap: 5px; margin-bottom: 20px; }
        input { padding: 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; flex: 1; }
        button { padding: 12px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; transition: 0.2s; }
        .btn-main { background: #007bff; color: white; width: 100%; margin-bottom: 5px; }
        .btn-sub { background: #28a745; color: white; }
        .btn-clear { background: #6c757d; color: white; width: 100%; }
        .log { font-size: 0.9rem; border: 1px solid #eee; padding: 10px; height: 150px; overflow-y: auto; background: #fafafa; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="view-title">店員用ターミナル</h2>
    
    <div class="price-display">¥<span id="total-price">0</span></div>

    <div id="controls">
        <div id="interactive" class="viewport"></div>
        <button class="btn-main" onclick="startScanner()">スキャナー起動</button>
        
        <p style="margin: 10px 0 5px;">▼金額を直接打つ</p>
        <div class="input-group">
            <input type="number" id="manualAmount" placeholder="金額を入力">
            <button class="btn-sub" onclick="addManual()">追加</button>
        </div>

        <button class="btn-clear" onclick="clearCart()">全部消去（お会計完了）</button>

        <h4>販売履歴</h4>
        <div id="log" class="log"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBWmqdhnlEPxm3DgJDQk0qZ-EFrq8SBU_I",
        authDomain: "kuraberukun-e638b.firebaseapp.com",
        projectId: "kuraberukun-e638b",
        storageBucket: "kuraberukun-e638b.firebasestorage.app",
        databaseURL: "https://kuraberukun-e638b-default-rtdb.firebaseio.com",
        messagingSenderId: "796604463328",
        appId: "1:796604463328:web:93987f5299edc5a3cb3885"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const posRef = ref(db, 'pos_data');
    const masterRef = ref(db, 'item_master');

    let currentTotal = 0;
    let itemMaster = {};

    // 1. マスターデータの読み込み
    onValue(masterRef, (snapshot) => {
        itemMaster = snapshot.val() || {};
    });

    // 2. リアルタイム同期（客用・店員用共通）
    onValue(posRef, (snapshot) => {
        const data = snapshot.val();
        currentTotal = data ? data.total : 0;
        document.getElementById('total-price').innerText = currentTotal.toLocaleString();
        if(data && data.lastItem) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = `<div>${data.lastItem}: ¥${data.lastPrice}</div>` + logDiv.innerHTML;
        }
        if(currentTotal === 0) document.getElementById('log').innerHTML = "";
    });

    // 金額をFirebaseへ送る
    function updateFirebase(amount, name) {
        set(posRef, {
            total: currentTotal + amount,
            lastItem: name,
            lastPrice: amount
        });
    }

    // 直接入力
    window.addManual = () => {
        const input = document.getElementById('manualAmount');
        const val = parseInt(input.value);
        if (val) {
            updateFirebase(val, "直接入力");
            input.value = "";
        }
    };

    window.clearCart = () => {
        set(posRef, { total: 0, lastItem: "", lastPrice: 0 });
    };

    // 3. スキャナー機能
    window.startScanner = () => {
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
            decoder: { readers: ["ean_reader"] }
        }, (err) => { if (!err) Quagga.start(); });
    };

    Quagga.onDetected((result) => {
        const code = result.codeResult.code;
        if (itemMaster[code]) {
            const item = itemMaster[code];
            Quagga.stop();
            updateFirebase(item.price, item.name);
            setTimeout(() => Quagga.start(), 2000);
        } else {
            // 未登録ならその場で登録
            Quagga.stop();
            const name = prompt("新商品です。名前を入力してください:");
            const price = parseInt(prompt("価格を入力してください:"));
            if (name && price) {
                set(ref(db, 'item_master/' + code), { name: name, price: price });
                updateFirebase(price, name);
            }
            Quagga.start();
        }
    });

    // 客用画面モードの切り替え（URLに ?view=customer をつけると操作パネルが消える）
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') === 'customer') {
        document.getElementById('controls').style.display = 'none';
        document.getElementById('view-title').innerText = 'ご案内';
    }
</script>
</body>
</html>
