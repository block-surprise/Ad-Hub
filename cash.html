<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>レジ - ストアスキャン版</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --bg: #f8f9fa; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); text-align: center; }
        .app-container { max-width: 500px; margin: 0 auto; background: white; min-height: 100vh; }
        header { background: var(--primary); color: white; padding: 15px; font-weight: bold; }
        .total-section { padding: 30px; border-bottom: 2px solid #eee; }
        .total-amount { font-size: 4.5rem; font-weight: bold; color: var(--primary); margin: 0; }
        #video-container { width: 100%; height: 180px; background: #000; position: relative; }
        #preview { width: 100%; height: 100%; object-fit: cover; }
        .controls { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        input { padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.2rem; text-align: center; }
        button { padding: 15px; border-radius: 10px; border: none; font-weight: bold; color: white; cursor: pointer; font-size: 1.1rem; }
        
        /* 決済用QRモーダル */
        #pay-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        #pay-qr { margin: 20px; }
    </style>
</head>
<body>

<div class="app-container">
    <header>店舗レジ (Store Scan Mode)</header>
    <div id="video-container"><video id="preview" playsinline></video></div>
    
    <div class="total-section">
        <div style="color:#999;">合計金額</div>
        <div class="total-amount">¥<span id="total-price">0</span></div>
        <div id="status-msg" style="color:var(--accent); font-weight:bold; margin-top:10px;">READY</div>
    </div>

    <div class="controls">
        <input type="number" id="manual-price" placeholder="金額を入力">
        <button style="background:var(--accent);" onclick="addManual()">➕ 金額を追加</button>
        <button style="background:var(--success);" onclick="showPayQR()">✨ 決済用QRを表示</button>
        <button style="background:#bbb;" onclick="resetAll()">リセット</button>
    </div>
</div>

<div id="pay-modal">
    <h2 style="color:#333;">お客様にスキャンしてもらってください</h2>
    <div id="pay-qr"></div>
    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">請求額: ¥<span id="modal-amt">0</span></div>
    <button onclick="closeModal()" style="background:#666; width: 200px; margin-top: 30px;">閉じる</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBWmqdhnlEPxm3DgJDQk0qZ-EFrq8SBU_I",
        databaseURL: "https://kuraberukun-e638b-default-rtdb.firebaseio.com",
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const posRef = ref(db, 'pos_data');
    const masterRef = ref(db, 'item_master');

    let currentTotal = 0;
    let itemMaster = {};

    onValue(masterRef, (snapshot) => { itemMaster = snapshot.val() || {}; });

    // 合計金額を更新
    function updateVal(amt, name) {
        currentTotal = amt;
        document.getElementById('total-price').innerText = currentTotal.toLocaleString();
        document.getElementById('status-msg').innerText = name;
    }

    window.addManual = () => {
        const p = parseInt(document.getElementById('manual-price').value);
        if (p) { updateVal(currentTotal + p, "手入力追加"); document.getElementById('manual-price').value = ""; }
    };

    window.showPayQR = () => {
        if (currentTotal <= 0) return;
        document.getElementById('pay-qr').innerHTML = "";
        // QRの中身に「PAY_金額_時間」を込める
        const payCode = `PAY_${currentTotal}_${Date.now()}`;
        new QRCode(document.getElementById('pay-qr'), { text: payCode, width: 280, height: 280 });
        document.getElementById('modal-amt').innerText = currentTotal.toLocaleString();
        document.getElementById('pay-modal').style.display = 'flex';
    };

    window.closeModal = () => document.getElementById('pay-modal').style.display = 'none';
    window.resetAll = () => updateVal(0, "READY");

    // 商品スキャン用
    const video = document.getElementById("preview");
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
        video.srcObject = s; video.play(); requestAnimationFrame(tick);
    });

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight; canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            if (code && code.data) {
                if (itemMaster[code.data]) {
                    updateVal(currentTotal + itemMaster[code.data].price, itemMaster[code.data].name);
                } else {
                    const name = prompt("新商品名:");
                    const price = parseInt(prompt("価格:"));
                    if(name && price) {
                        update(ref(db, `item_master/${code.data}`), { name, price });
                        updateVal(currentTotal + price, name);
                    }
                }
                // 連続スキャン防止
                video.pause(); setTimeout(() => video.play(), 1500);
            }
        }
        requestAnimationFrame(tick);
    }
</script>
</body>
</html>
