<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Master POS System - Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --pay: #9b59b6; --bg: #f8f9fa; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); }
        .app-container { max-width: 500px; margin: 0 auto; background: white; min-height: 100vh; }
        header { background: var(--primary); color: white; padding: 12px; text-align: center; }
        #video-container { width: 100%; height: 250px; background: #000; position: relative; }
        #preview { width: 100%; height: 100%; object-fit: cover; }
        .total-display { padding: 20px; text-align: center; border-bottom: 2px solid #eee; }
        .total-amount { font-size: 4rem; font-weight: bold; margin: 0; }
        .controls { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        button { border: none; border-radius: 8px; padding: 15px; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; }
        .btn-pay { background: var(--pay); }
        .btn-cash { background: var(--success); }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        /* ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã«ä¸€ç¬å…‰ã‚‰ã›ã‚‹æ¼”å‡º */
        .flash { animation: flash-animation 0.2s; }
        @keyframes flash-animation { from { background: #fff; } to { background: #27ae60; } }
    </style>
</head>
<body>

<div class="app-container" id="main-app">
    <header>åº—å“¡ãƒ¬ã‚¸ãƒ¢ãƒ¼ãƒ‰</header>
    <div id="video-container"><video id="preview" playsinline></video></div>
    
    <div class="total-display">
        <div style="color:#999;">åˆè¨ˆé‡‘é¡</div>
        <div class="total-amount">Â¥<span id="total-price">0</span></div>
        <div id="status-msg" style="color:var(--accent); font-weight:bold;">ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­</div>
    </div>

    <div class="controls">
        <button class="btn-pay" onclick="finishPayment('è‡ªç¤¾Pay')">ğŸ“± è‡ªç¤¾Payæ±ºæ¸ˆã‚’ç¢ºå®š</button>
        <button class="btn-cash" onclick="finishPayment('ç¾é‡‘')">ğŸ’µ ç¾é‡‘ä¼šè¨ˆ</button>
        <div style="display:flex; gap:5px;">
            <input type="number" id="manual-price" placeholder="æ‰‹å…¥åŠ›é‡‘é¡">
            <button style="background:var(--accent); width:120px;" onclick="addManual()">è¿½åŠ </button>
        </div>
        <button style="background:#bbb;" onclick="clearCart()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBWmqdhnlEPxm3DgJDQk0qZ-EFrq8SBU_I",
        authDomain: "kuraberukun-e638b.firebaseapp.com",
        projectId: "kuraberukun-e638b",
        databaseURL: "https://kuraberukun-e638b-default-rtdb.firebaseio.com",
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const posRef = ref(db, 'pos_data');
    const masterRef = ref(db, 'item_master');

    let currentTotal = 0;
    let itemMaster = {};
    let isScanningLocked = false; // ã‚¹ã‚­ãƒ£ãƒ³é€£æ‰“é˜²æ­¢ãƒ•ãƒ©ã‚°

    // ãƒ‡ãƒ¼ã‚¿å—ä¿¡
    onValue(posRef, (snapshot) => {
        const data = snapshot.val();
        currentTotal = data ? data.total : 0;
        document.getElementById('total-price').innerText = currentTotal.toLocaleString();
        if(data?.lastItem) document.getElementById('status-msg').innerText = data.lastItem;
    });
    onValue(masterRef, (snapshot) => { itemMaster = snapshot.val() || {}; });

    // ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†
    async function processScan(data) {
        if (isScanningLocked) return;
        isScanningLocked = true; // ãƒ­ãƒƒã‚¯

        if (itemMaster[data]) {
            const item = itemMaster[data];
            await set(posRef, { total: currentTotal + item.price, lastItem: item.name });
            flashScreen();
        } else {
            // æœªç™»éŒ²å•†å“ã¯ãã®å ´ã§ç™»éŒ²
            const name = prompt("æ–°å•†å“å:");
            const price = parseInt(prompt("ä¾¡æ ¼:"));
            if (name && price) {
                await update(ref(db, `item_master/${data}`), { name, price });
                await set(posRef, { total: currentTotal + price, lastItem: name });
            }
        }
        
        // 1.5ç§’å¾Œã«ã‚¹ã‚­ãƒ£ãƒ³å†é–‹å¯èƒ½ã«ã™ã‚‹
        setTimeout(() => { isScanningLocked = false; }, 1500);
    }

    // ä¼šè¨ˆç¢ºå®š
    window.finishPayment = async (method) => {
        if (currentTotal <= 0) return;
        const finalAmount = currentTotal;
        await set(posRef, { total: 0, lastItem: `${method}æ±ºæ¸ˆå®Œäº†_${finalAmount}` });
        alert(method + "æ±ºæ¸ˆå®Œäº†: Â¥" + finalAmount);
    };

    window.addManual = () => {
        const p = parseInt(document.getElementById('manual-price').value);
        if (p) { set(posRef, { total: currentTotal + p, lastItem: "æ‰‹å…¥åŠ›è¿½åŠ " }); }
    };

    window.clearCart = () => set(posRef, { total: 0, lastItem: "ãƒªã‚»ãƒƒãƒˆ" });

    function flashScreen() {
        const el = document.getElementById('main-app');
        el.classList.add('flash');
        setTimeout(() => el.classList.remove('flash'), 200);
    }

    // ã‚«ãƒ¡ãƒ©ãƒ«ãƒ¼ãƒ—
    const video = document.getElementById("preview");
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
        video.srcObject = s; video.play();
        requestAnimationFrame(tick);
    });

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA && !isScanningLocked) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code && code.data) {
                processScan(code.data);
            }
        }
        requestAnimationFrame(tick);
    }
</script>
</body>
</html>
